workflows:
  android-production:
    name: Android Production Build
    instance_type: mac_mini_m2  # Technically, linux_x2 is cheaper but is not included in the free tier
    max_build_duration: 60
    environment:
      groups:
        - Production
      vars:
        EAS_PROFILE: production
        EAS_NO_VCS: "1"
      node: 18
      # Android signing configuration
      android_signing:
        - PiggusProd
    cache:
      cache_paths:
        - node_modules
        - .expo
        - .eas
    triggering:
      events:
        - push
      branch_patterns:
        - pattern: main
          include: true
    scripts:
      - name: Install dependencies
        script: npm install

      - name: Install EAS CLI
        script: npm install -g eas-cli

      - name: Build Android locally
        script: SENTRY_DISABLE_AUTO_UPLOAD=true EXPO_TOKEN=$EXPO_TOKEN eas build --local --platform android --profile $EAS_PROFILE

      - name: Upload Sentry sourcemaps (Android)
        script: |
          if [ -n "$SENTRY_AUTH_TOKEN" ]; then
            npx sentry-cli releases new "$CM_BUILD_ID-android"
            npx sentry-cli releases files "$CM_BUILD_ID-android" upload-sourcemaps ./ --rewrite --url-prefix "~/"
            npx sentry-cli releases finalize "$CM_BUILD_ID-android"
          else
            echo "SENTRY_AUTH_TOKEN not set, skipping sourcemap upload"
          fi

    artifacts:
      - "*.aab"
      - "*.apk"
      - build-*.aab
      - build-*.apk

    publishing:
      google_play:
        credentials: $GOOGLE_PLAY_SERVICE_ACCOUNT_CREDENTIALS
        track: internal  # Options: internal, alpha, beta, production
        submit_as_draft: false  # Creates draft for manual review before publishing
        release_promotion:
          track: production
          promote_as_draft: true

  ios-production:
    name: iOS Production Build
    instance_type: mac_mini_m2  # Required for iOS builds
    max_build_duration: 60
    integrations:
      app_store_connect: Codemagic Piggus
    environment:
      groups:
        - Production
      vars:
        EAS_PROFILE: production-codemagic
        EAS_NO_VCS: "1"
        EXPO_NO_CAPABILITY_SYNC: "1"  # Prevent EAS from managing capabilities
      node: 18
      xcode: latest
      ios_signing:
        distribution_type: app_store
        bundle_identifier: com.rebelpug.piggus
    cache:
      cache_paths:
        - node_modules
        - .expo
        - .eas
    triggering:
      events:
        - push
      branch_patterns:
        - pattern: main
          include: true
    scripts:
      - name: Install dependencies
        script: npm install

      - name: Install EAS CLI
        script: npm install -g eas-cli

      - name: Build iOS locally
        script: |
          SENTRY_DISABLE_AUTO_UPLOAD=true \
          EXPO_TOKEN=$EXPO_TOKEN \
          EXPO_NO_CAPABILITY_SYNC=1 \
          eas build --local --platform ios --profile $EAS_PROFILE --non-interactive

      - name: Upload Sentry sourcemaps (iOS)
        script: |
          if [ -n "$SENTRY_AUTH_TOKEN" ]; then
            npx sentry-cli releases new "$CM_BUILD_ID-ios"
            npx sentry-cli releases files "$CM_BUILD_ID-ios" upload-sourcemaps ./ --rewrite --url-prefix "~/"
            npx sentry-cli releases finalize "$CM_BUILD_ID-ios"
          else
            echo "SENTRY_AUTH_TOKEN not set, skipping sourcemap upload"
          fi

    artifacts:
      - "*.ipa"
      - build-*.ipa

    publishing:
      app_store_connect:
        auth: integration  # You need to set up App Store Connect integration in Codemagic UI
        submit_to_testflight: true  # Automatic beta testing
        submit_to_app_store: false  # Manual App Store submission for production
